templateVersion: 2.0

meta:
  org: "dip"
  pod: "sp"
  name: "one-compass-service"
  tier: 2
  version: "0.1"
  frameworks:
    - name: "python"
      version: "3.8.12"
  slackChannel: "anobis-sentry-alerts"

sos:
  type: "core_tech_capability"
  name: "business_metric_reporting"

infra:
  compute: # This is for prod. For QA and dev,we'll manage.
    type: "Container" # could be VM or Container
    networkProxySideCar: false
    sidecars:
      - name: "statsd"
        image: "157529275398.dkr.ecr.ap-southeast-1.amazonaws.com/cicd/dp-ie/statsd:v0.22.4-logs-1"
        port: 9125
        protocol: "http"
        cpu: 0.5
        memory: "500Mi"
        healthURL: "/health"
        healthPort: 9102
        healthCheck: true
        healthProtocol: "http"
        metricURL: "/metrics"
        metricPort: 9102
    cpu: 6
    memory: "8Gi"
    appPort: 8088
    appProtocol: "http"
    healthCheck: true
    healthProtocol: "http"
    healthPort: 9102
    healthURL: "/health"
    scaling:
      min: 8
      max: 20
      metric:
        type: "cpu_2m"
        target: 50
      timeBased:
        - schedule: "00 12 25 12 *"   #upscale event scheduled for dinner peak at 5:30PM IST on Dec 25th
          replicas: 12
        - schedule: "30 21 25 12 *"   #downscale event scheduled midnight 3:00AM on Dec 26th
          replicas: 8
        - schedule: "00 12 31 12 *"   #upscale event scheduled for dinner peak at 5:30PM IST on Dec 31st
          replicas: 12
        - schedule: "30 21 31 12 *"   #downscale event scheduled midnight 3:00AM on Jan 1st
          replicas: 8
    startupTime: 50s
    gracePeriod: 60s
    requestTimeout: 120s
    alias: "one-compass.swiggyops.de"
    logging:
      backend: "sumologic"# supports only sumologic and s3

  storage:
    - type: "redis"
      name: "onecompassredis"
      params:
        memory: "10Gi"
        throughput: 60000
    - type: "mysql"
      name: "onecompassdb"
      params:
        database: "one_compass_prod"
        schema: "deployment/mysql_dump/shuttle_cd/"
        grant: "SELECT,INSERT,UPDATE,DELETE"
        disk: "30Gi"
        cpu: 4
        memory: "16Gi"
        rps: 1000
        wps: 1000
        slaves: # For all the slaves, grant would automatically be only SELECT
        - name: "reader"
          disk: "30Gi"
          rps: 1000
    - type: "ref"
      name: "compasswebservices3"
      params:
        serviceName: "compass-web-service"
        org: "dip"
        pod: "sp"
        storageType: "S3"
        storageName: "compasswebservices3"
        versioning: false
        objectLock: false

pipeline:
  stages:
    - name: "prod-deploy"
      env: "production"
      actions:
        - type: "deploy"
          name: "deploy"
          params:
            strategy: "canary"
            canaryStages:
              - share: 0
                approver: "dev"
              - share: 1
                approver: "dev"
              - share: 10
                approver: "dev"

ciSetup:
  baseContainer:
    name: "ubuntu18"
    resources:
      cpu: "4"
      memory: "8Gi"

envVar:
  #   Absence of any of the secrets fails the deploy action
  secret: # This section contains only the references of mandatory secrets for validation purposes.
    - AZURE_APPLICATION_ID
    - AZURE_SECRET
  config: # Overrides only
    ref: "deployment/one-compass-conf/" # Folder path to conf from the root
    sidecars:
      - name: "statsd"
        ref: "deployment/statsd-conf/"
